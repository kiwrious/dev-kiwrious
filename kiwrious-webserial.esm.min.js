var de=Object.create;var re=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var ge=Object.getPrototypeOf,ye=Object.prototype.hasOwnProperty;var ae=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Re=(r,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of pe(e))!ye.call(r,n)&&n!==t&&re(r,n,{get:()=>e[n],enumerable:!(a=he(e,n))||a.enumerable});return r};var me=(r,e,t)=>(t=r!=null?de(ge(r)):{},Re(e||!r||!r.__esModule?re(t,"default",{value:r,enumerable:!0}):t,r));var oe=ae(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});var Se=function(){function r(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e}}();function Te(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var Ee=function(){function r(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Float32Array;Te(this,r),e instanceof r?(this.ArrayType=e.ArrayType,this.real=new this.ArrayType(e.real),this.imag=new this.ArrayType(e.imag)):(this.ArrayType=t,this.real=new this.ArrayType(e),this.imag=new this.ArrayType(this.real.length)),this.length=this.real.length}return Se(r,[{key:"toString",value:function(){var t=[];return this.forEach(function(a,n){t.push("("+a.real.toFixed(2)+", "+a.imag.toFixed(2)+")")}),"["+t.join(", ")+"]"}},{key:"forEach",value:function(t){for(var a=this.length,n=Object.seal(Object.defineProperties({},{real:{writable:!0},imag:{writable:!0}})),s=0;s<a;s++)n.real=this.real[s],n.imag=this.imag[s],t(n,s,a)}},{key:"map",value:function(t){var a=this;return this.forEach(function(n,s,o){t(n,s,o),a.real[s]=n.real,a.imag[s]=n.imag}),this}},{key:"conjugate",value:function(){return new r(this).map(function(t){t.imag*=-1})}},{key:"magnitude",value:function(){var t=new this.ArrayType(this.length);return this.forEach(function(a,n){t[n]=Math.sqrt(a.real*a.real+a.imag*a.imag)}),t}}]),r}();z.default=Ee});var ie=ae(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.ComplexArray=void 0;var Ae=function(){function r(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e}}();S.FFT=Oe;S.InvFFT=Fe;S.frequencyMap=Pe;var be=oe(),Ie=Ve(be);function Ve(r){return r&&r.__esModule?r:{default:r}}function xe(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function De(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function Ue(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}var L=Math.PI,M=Math.SQRT1_2;function Oe(r){return Z(r).FFT()}function Fe(r){return Z(r).InvFFT()}function Pe(r,e){return Z(r).frequencyMap(e)}var Y=S.ComplexArray=function(r){Ue(e,r);function e(){return xe(this,e),De(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return Ae(e,[{key:"FFT",value:function(){return K(this,!1)}},{key:"InvFFT",value:function(){return K(this,!0)}},{key:"frequencyMap",value:function(a){return this.FFT().map(a).InvFFT()}}]),e}(Ie.default);function Z(r){return r instanceof Y&&r||new Y(r)}function K(r,e){var t=r.length;return t&t-1?He(r,e):Ce(r,e)}function He(r,e){var t=r.length;if(t===1)return r;for(var a=new Y(t,r.ArrayType),n=Me(t),s=t/n,o=1/Math.sqrt(n),l=new Y(s,r.ArrayType),c=0;c<n;c++){for(var u=0;u<s;u++)l.real[u]=r.real[u*n+c],l.imag[u]=r.imag[u*n+c];s>1&&(l=K(l,e));for(var h=Math.cos(2*L*c/t),g=(e?-1:1)*Math.sin(2*L*c/t),v=1,f=0,m=0;m<t;m++){var A=l.real[m%s],b=l.imag[m%s];a.real[m]+=v*A-f*b,a.imag[m]+=v*b+f*A;var I=[v*h-f*g,f=v*g+f*h];v=I[0],f=I[1]}}for(var _=0;_<t;_++)r.real[_]=o*a.real[_],r.imag[_]=o*a.imag[_];return r}function Ce(r,e){for(var t=r.length,a=Be(r),n=a.real,s=a.imag,o=1;o<t;){for(var l=Math.cos(L/o),c=(e?-1:1)*Math.sin(L/o),u=0;u<t/(2*o);u++)for(var h=1,g=0,v=0;v<o;v++){var f=2*u*o+v,m=f+o,A=n[f],b=s[f],I=h*n[m]-g*s[m],_=g*n[m]+h*s[m];n[f]=M*(A+I),s[f]=M*(b+_),n[m]=M*(A-I),s[m]=M*(b-_);var te=[h*l-g*c,h*c+g*l];h=te[0],g=te[1]}o<<=1}return a}function Ne(r,e){for(var t=0;e>1;)t<<=1,t+=r&1,r>>=1,e>>=1;return t}function Be(r){for(var e=r.length,t=new Set,a=0;a<e;a++){var n=Ne(a,e);if(!t.has(a)){var s=[r.real[n],r.real[a]];r.real[a]=s[0],r.real[n]=s[1];var o=[r.imag[n],r.imag[a]];r.imag[a]=o[0],r.imag[n]=o[1],t.add(n)}}return r}function Me(r){for(var e=Math.sqrt(r),t=3;t<=e;){if(r%t===0)return t;t+=2}return r}});var V=class{constructor(e){this.rawHexValue=e}toFloat(){let e=Number(this.rawHexValue),t=e&2147483648?-1:1,a=(e>>23&255)-127,n=1+(e&8388607)/8388607;return t*n*Math.pow(2,a)}toInt(){return Number(parseInt(this.rawHexValue).toFixed())}divideByHundred(){return Number((parseInt(this.rawHexValue)/100).toFixed())}},y=class{constructor(e){this._raw=e}get value(){return this._raw}toInt(){return Number(this._raw.toFixed())}divideByHundred(){return Number((this._raw/100).toFixed())}};var i={UNKNOWN:"UNKNOWN",UV:"UV",UV2:"UV2",HUMIDITY:"HUMIDITY",VOC:"VOC",CONDUCTIVITY:"CONDUCTIVITY",HEART_RATE:"HEART_RATE",HEART_RATE2:"HEART_RATE2",TEMPERATURE:"TEMPERATURE",TEMPERATURE2:"TEMPERATURE2"},d={UNKNOWN:"UNKNOWN",UV_INDEX:"Uv",LUX:"Lux",HUMIDITY:"Hum",TEMPERATURE:"Temp",VOC:"Voc",CONDUCTIVITY:"Con",HEART_RATE:"HeartRate",INFRARED_TEMPERATURE:"InfraredTemp",AMBIENT_TEMPERATURE:"AmbientTemp"},fe=new Map([["UV",2],["HUMIDITY",void 0],["VOC",void 0],["CONDUCTIVITY",void 0],["HEART_RATE",2],["TEMPERATURE",2]]),w=class{constructor(e){if(this.rawValue=e,this.dataView=new DataView(e.buffer),!this.isValidLength)throw new Error(`invalid array length. expected [] but got [${e.length}]`)}get isValidLength(){return this.rawValue.length===26}get sensorTypeRaw(){return this.rawValue[2]}get header2Bytes(){return this.getTwoBytesByIndex(0)}get sequence2Bytes(){return this.getTwoBytesByIndex(22)}get footer2Bytes(){return this.getTwoBytesByIndex(24)}get decoderType(){switch(this.sensorTypeRaw){case 1:return i.UV;case 2:return i.TEMPERATURE;case 4:return i.CONDUCTIVITY;case 5:return i.HEART_RATE;case 6:return i.VOC;case 7:return i.HUMIDITY;case 9:return i.TEMPERATURE2;case 10:return i.HEART_RATE2;case 11:return i.UV2;default:throw new Error(`invalid sensor type ${this.sensorTypeRaw}`)}}get isFirmwareOutdated(){let e=/\d$/gm;return this.decoderType.match(e)?.toString()!=fe.get(this.sensorType)}get sensorType(){let e=/\d$/gm;return this.decoderType.replace(e,"")}getTwoBytesSignedByIndex(e){return this.dataView.getInt16(e,!0)}getTwoBytesUnsignedByIndex(e){return this.dataView.getUint16(e,!0)}getTwoBytesByIndex(e){return this.dataView.getUint16(e,!0)}getFourBytesByIndex(e){return this.dataView.getUint32(e,!0)}getFourBytesFloatByIndex(e){return this.dataView.getFloat32(e,!0)}sliceBytes(e,t){if(e+t>this.rawValue.length)throw new Error(`invalid index [${e}] for array length [${this.rawValue.length}]`);return this.rawValue.slice(e,e+t)}getByteByIndex(e){if(e>=this.rawValue.length)throw new Error(`invalid index [${e}] for array length [${this.rawValue.length}]`);return this.rawValue[e]}getHexDigitByIndex(e){if(e>=this.rawValue.length)throw new Error(`invalid index [${e}] for array length [${this.rawValue.length}]`);return this.rawValue[e].toString(16).padStart(2,"0")}getHexString2(e,t){let a=this.getHexDigitByIndex(e),n=this.getHexDigitByIndex(t),s=`0x${a}${n}`;return new V(s)}getHexString4(e,t,a,n){let s=this.getHexDigitByIndex(e),o=this.getHexDigitByIndex(t),l=this.getHexDigitByIndex(a),c=this.getHexDigitByIndex(n),u=`0x${s}${o}${l}${c}`;return new V(u)}};var T=class{static concatArray(e,t){let a=new Uint8Array(e.length+t.length);return a.set(e,0),a.set(t,e.length),a}static concatMultiArrays(e){let t=e.reduce((n,s)=>n+s.length,0),a=new Uint8Array(t);return e.reduce((n,s)=>(a.set(s,n),n+s.length),0),a}};var O=26,F=class{constructor(e){this._reader=e,this._array=new Uint8Array}_log(...e){console.log("|SerialReader|",...e)}_err(...e){console.error("|SerialReader|",...e)}async _read(){if(this._array.length>=O){let n=this._array.subarray(0,O);return this._array=this._array.subarray(O),new w(n)}if(!this._reader)throw this._err("readLoop - no reader. returning"),new Error("no reader");let e=await this._reader.read(),{value:t,done:a}=e;if(a)throw new Error("reader done");return t.length===O?(this._array=new Uint8Array,new w(t.subarray(0))):(this._array=T.concatArray(this._array,t),await this.readOnce())}async readMultiple(e=10){let t=[];for(;t.length<e;){let a=await this._read();t.push(a)}return t}async readOnce(){let e=await this._read();return e}};var p=class{constructor(){}_log(...e){console.log("|SerialDecoder|",...e)}_err(...e){console.error("|SerialDecoder|",...e)}};var P=class extends p{constructor(){super()}_log(...e){console.log("|HumiditySerialDecoder|",...e)}async decode(e){if(!e.length)throw new Error("invlalid input. expected 1 value at least");let t=e[0];if(!t.isValidLength)return this._log(`invalid length ${t.rawValue.length}. skipping..`),null;let a=new y(t.getTwoBytesSignedByIndex(6)).divideByHundred(),n=new y(t.getTwoBytesSignedByIndex(8)).divideByHundred(),s={label:d.TEMPERATURE,value:a,type:"number"},o={label:d.HUMIDITY,value:n,type:"number"};return{sensorType:t.sensorType,decodedValues:[s,o]}}};var H=class extends p{constructor(){super()}_log(...e){console.log("|UVSerialDecoder|",...e)}async decode(e){if(!e.length)throw new Error("invlalid input. expected 1 value at least");let t=e[0],a=t.getFourBytesFloatByIndex(6).toFixed(0),n=t.getFourBytesFloatByIndex(10).toFixed(1),s={label:d.LUX,value:a,type:"number"},o={label:d.UV_INDEX,value:n,type:"number"};return{sensorType:t.sensorType,decodedValues:[s,o]}}};var ve=2e4,ne=1e3,C=100,N=class extends p{constructor(){super();this._hasStartedWaitingForData=!1;this._dataReadyPercentage=0;this._incrementPercentage=ne*C/ve}async decode(t){if(!t.length)throw new Error("invlalid input. expected 1 value at least");let a=t[0];if(!a.isValidLength)return this._log(`invalid length ${a.rawValue.length}. skipping..`),null;this._hasStartedWaitingForData||this.startIntervalForDataReady();let n=a.getTwoBytesByIndex(6);n>0&&this.clearIntervalIfRunning();let s={status:this._dataReadyPercentage!==C?se.PROCESSING:se.READY,dataReadyPercentage:this._dataReadyPercentage,value:n},o={label:d.VOC,value:s,type:"object"};return{sensorType:a.sensorType,decodedValues:[o]}}clearIntervalIfRunning(){this._dataReadyIntervalId&&(this._log("clearIntervalIfRunning"),clearInterval(this._dataReadyIntervalId),this._dataReadyIntervalId=void 0,this._dataReadyPercentage=C)}startIntervalForDataReady(){this._log("start interval for data ready.."),this.runOneInterval(),this._dataReadyIntervalId=setInterval(()=>{this.runOneInterval()},ne),this._hasStartedWaitingForData=!0}runOneInterval(){if(this._dataReadyPercentage>=C){this.clearIntervalIfRunning();return}this._dataReadyPercentage+=this._incrementPercentage}},se={PROCESSING:"PROCESSING",READY:"READY"};var j={MAX:"MAX",MIN:"MIN",READY:"READY"},_e=2e5,we=65535,B=class r extends p{constructor(){super()}_log(...e){console.log("|ConductivitySerialDecoder|",...e)}async decode(e){if(!e.length)throw new Error("invlalid input. expected 1 value at least");let t=e[0];if(!t.isValidLength)return this._log(`invalid length ${t.rawValue.length}. skipping..`),null;let a=t.getTwoBytesByIndex(6),n=t.getTwoBytesByIndex(8),s=r.calculateConductivity(a,n),o={label:d.CONDUCTIVITY,value:s,type:"object"};return{sensorType:t.sensorType,decodedValues:[o]}}static calculateConductivity(e,t){if(e>=we)return{value:0,status:j.MIN};let a=Number((1/(e*t)*Math.pow(10,6)).toFixed(1));return a>_e?{value:"MAX",status:j.MAX}:{value:a,status:j.READY}}};var ue=me(ie(),1),Le=3e5,Ye=9e5,$e=200,le=2048,ke=100,Ge=[[[1,0,-1],[1,-1.9794,.9847]],[[1,0,-1],[1,-1.9948,.9953]],[[1,0,-1],[1,-1.9537,.9583]],[[1,0,-1],[1,-1.9849,.9855]],[[1,0,-1],[1,-1.973,.9737]],[[1,0,-1],[1,-1.9392,.9426]],[[1,0,-1],[1,-1.9571,.9583]],[[1,0,-1],[1,-1.941,.9432]]],qe=[.0256,.0256,.0254,.0254,.0252,.0252,.0251,.0251,1],R={TOO_LOW:"TOO_LOW",TOO_HIGH:"TOO_HIGH",PROCESSING:"PROCESSING",READY:"READY"},x=class r{constructor(e){this._size=e,this._array=[],this._sum=0}_log(...e){console.log("|FixedArray|",...e)}get isAverageReady(){return this._array.length>=this._size}get average(){return r.calcAverage(this._sum,this._array.length)}get array(){return this._array}_cleanup(){for(;this._array.length>this._size;){let e=this._array.shift();e&&(this._sum-=e)}}_add(e){this._array.push(e),this._sum+=e}add(e){this._add(e),this._cleanup()}addItems(e){for(let t of e)this._add(t);this._cleanup()}static calcSum(e){return e.reduce((t,a)=>t+a,0)}static calcAverage(e,t){return t?e/t:0}static createSteppedArray(e,t,a){let n=[],s=(t-e)/(a-1);for(let o=0;o<a;o++)n.push(e+s*o);return n}},Q=class{constructor(e,t,a,n){this.b=e,this.a=t,this.g1=a,this.g2=n,this.w=[1,1,1]}_log(...e){console.log("|Biquad|",...e)}updateFilter(e){let t=e*this.g1;return this.w[2]=this.w[1],this.w[1]=this.w[0],this.w[0]=t-this.a[1]*this.w[1]-this.a[2]*this.w[2],(this.b[0]*this.w[0]+this.b[1]*this.w[1]+this.b[2]*this.w[2])*this.g2}},E=class{constructor(){this._log("ctor"),this._initFilters();let e=Math.floor($e/2);this._resultArray=new x(ke),this._inputArray=new x(le);let a=Math.floor(le/2);this._xf=x.createSteppedArray(0,e,a)}_log(...e){console.log("|HeartRateProcessor|",...e)}_initFilters(){this._filters=Ge.map((e,t)=>new Q(e[0],e[1],qe[t],1))}getStatusForInput(e){return e<Le?R.TOO_LOW:e>Ye?R.TOO_HIGH:R.PROCESSING}processSingleInput(e){let t=this.getStatusForInput(e);if(t!==R.PROCESSING)return{status:t};this._inputArray.add(e);let a=this.process();return a?{status:R.READY,value:a}:{status:R.PROCESSING}}processMultiInput(e){for(let n of e){let s=this.getStatusForInput(n);if(s!==R.PROCESSING)return{status:s}}this._inputArray.addItems(e);let t=this.process();return t?{status:R.READY,value:t}:{status:R.PROCESSING}}process(){if(!this._inputArray.isAverageReady)return null;let e=this._process(this._inputArray);return!e||(this._resultArray.add(e),!this._resultArray.isAverageReady)?null:this._resultArray.average}_process(e){if(!e.isAverageReady)throw new Error(`average is not ready. arr len: ${e.array.length}`);let t=e.array.map(u=>{let h=u-e.average;return this._updateAllFilters(h)}),s=new ue.default.ComplexArray(t.length).map((u,h,g)=>{u.real=t[h]}).FFT().magnitude(),o=0,l=0;for(let u=0;u<s.length/2;u++){let h=s[u];h>o&&(o=h,l=u)}return this._xf[l]*60}_updateAllFilters(e){let t,a=e;for(let n of this._filters)t=n.updateFilter(a),a=t;return t}};var $=class extends p{constructor(){super(),this._processor=new E}_log(...e){console.log("|SerialHeartRateDecoder|",...e)}async decode(e){if(!e.length)throw new Error("invlalid input. expected 1 value at least");let t=e[0],a=t.getFourBytesByIndex(6),n=t.getFourBytesByIndex(10),s=t.getFourBytesByIndex(14),o=t.getFourBytesByIndex(18),l=this._processor.processMultiInput([a,n,s,o]),c={label:d.HEART_RATE,value:l,type:"object"};return{sensorType:t.sensorType,decodedValues:[c]}}};var k=class{constructor(){this.LOW_THRESHOLD=1e5;this.HIGH_THRESHOLD=2e6;this._isAboveHigh=!1}check(e){return e>this.HIGH_THRESHOLD?(this._isAboveHigh=!0,!0):this._isAboveHigh?e>this.LOW_THRESHOLD?!0:(this._isAboveHigh=!1,!1):!1}};var D=class extends p{constructor(){super();this._thresholdChecker=new k;this._postProcessor=new J;this._processor=new E,this._detector=new HeartRateDetector}_log(...t){console.log("|SerialHeartRateDecoder|",...t)}async decode(t){let a=t[0].rawValue.slice(0,26),s=new w(a).getFourBytesByIndex(6),o=this._thresholdChecker.check(s);this._log("rawValue",s,o);let l={label:d.HEART_RATE,value:{status:R.TOO_LOW,value:0},type:"object"},c={sensorType:t[0].sensorType,decodedValues:[l]},u=t.map(g=>g.rawValue.subarray(6,22)),h=T.concatMultiArrays(u);if(o){let g=await this._detector.detectHeartRate(h);this._log("heartrate-result",g);let v=this._postProcessor.process(g);l.value=v}return c}},J=class{constructor(){this._wasReady=!1}process(e){return e.status===R.PROCESSING&&this._wasReady&&(e.status=R.READY),this._wasReady=e.status===R.READY,e}};var G=class extends p{constructor(){super()}_log(...e){console.log("|TemperatureSerialDecoder|",...e)}async decode(e){if(!e.length)throw new Error("invlalid input. expected 1 value at least");let t=e[0];if(!t.isValidLength)return this._log(`invalid length ${t.rawValue.length}. skipping..`),null;let a=new y(t.getTwoBytesSignedByIndex(6)).divideByHundred(),n=new y(t.getTwoBytesSignedByIndex(8)).divideByHundred(),s={label:d.INFRARED_TEMPERATURE,value:a,type:"number"},o={label:d.AMBIENT_TEMPERATURE,value:n,type:"number"};return{sensorType:t.sensorType,decodedValues:[s,o]}}};var q=class extends p{constructor(){super()}_log(...e){console.log("|Temperature2SerialDecoder|",...e)}async decode(e){if(!e.length)throw new Error("invlalid input. expected 1 value at least");let t=e[0];if(!t.isValidLength)return this._log(`invalid length ${t.rawValue.length}. skipping..`),null;let a=new y(t.getTwoBytesSignedByIndex(6)).divideByHundred(),n=new y(t.getTwoBytesUnsignedByIndex(8)).value,s=new y(t.getFourBytesFloatByIndex(10)).value,o=new y(t.getFourBytesFloatByIndex(14)).value,l=new y(t.getFourBytesFloatByIndex(18)).value,c=(s*Math.pow(n,2)/Math.pow(10,5)+o*n+l).toFixed(0),u={label:d.AMBIENT_TEMPERATURE,value:a,type:"number"},h={label:d.INFRARED_TEMPERATURE,value:c,type:"number"};return{sensorType:t.sensorType,decodedValues:[u,h]}}};var W=class{async readValue(e){return[await e.readOnce()]}},X=class{async readValue(e){return await e.readMultiple(10)}};var U=class r{static _log(...e){console.log("|SerialDecoderFactory|",...e)}static _err(...e){console.error("|SerialDecoderFactory|",...e)}static createDecoder(e){switch(r._log("createDecoder"),r._log("type = "+e),e){case i.UV:case i.UV2:return new H;case i.HUMIDITY:return new P;case i.HEART_RATE:return new $;case i.HEART_RATE2:return new D;case i.VOC:return new N;case i.CONDUCTIVITY:return new B;case i.TEMPERATURE:return new G;case i.TEMPERATURE2:return new q;case i.HEART_RATE2:return new D;default:throw new Error(`invalid type ${e}`)}}static createReader(e){switch(r._log("createReader"),e){case i.UV:case i.UV2:case i.HUMIDITY:case i.HEART_RATE:case i.VOC:case i.CONDUCTIVITY:case i.TEMPERATURE:case i.TEMPERATURE2:return new W;case i.HEART_RATE2:return new X;default:throw new Error(`invalid type ${e}`)}}};var ee=class{constructor(){this._isConnected=!1;this._isReading=!1;this._log("ctor")}_log(...e){console.log("|SerialService|",...e)}_err(...e){console.error("|SerialService|",...e)}_warn(...e){console.warn("|SerialService|",...e)}get isReading(){return this._isReading}get canResumeReading(){return!!this._port}triggerStopReading(){this._isReading=!1}closeReader(){if(this._log("closing reader.."),!this._reader){this._log("no reader found. exiting..");return}this.triggerStopReading(),this._log("cancelling.."),this._reader.cancel(),this._log("releasing lock.."),this._reader.releaseLock(),this._reader=null,this._log("reader closed")}async closePortAsync(){if(this._log("closing port.."),!this._port){this._log("no port found. exiting..");return}this._isConnected=!1;try{await this._port.close(),this._log("port closed")}catch(e){this._err("failed to close port",e)}this.onSerialConnection&&this.onSerialConnection(this._isConnected)}async resumeReading(){if(this._log("resume reading.."),!this._port){this._log("port not found, restarting.."),await this.connectAndReadAsync();return}return await this.startStage2ConnectPortAsync(this._port)}async disconnectAsync(){this._log("disconnecting.."),this.triggerStopReading(),setTimeout(async()=>{await this.stopStage2ClosePortAsync()},0)}async connectAndReadAsync(){this._log("connect and read..");let e=await this.startStage1RequestPortAsync();if(!e){this._err("unable to request port");return}return await this.startStage2ConnectPortAsync(e)}async startStage1RequestPortAsync(){let{serial:e}=navigator;if(!e)return alert("This feature only works on Chrome with 'Experimental Web Platform features' enabled"),null;e.onconnect=()=>{this._log("serial connect")},e.ondisconnect=async()=>{this._log("serial disconnect"),await this.disconnectAsync(),this._port=null},this._log("requesting port..");let t=await e.requestPort({filters:[{usbVendorId:1240,vendorId:1240},{usbVendorId:3368,usbProductId:516}]}).catch(a=>{this._err("failed to serial.requestPort",a)});return t||(this._err("unable to find port value"),null)}async startStage2ConnectPortAsync(e){this._log("startStage2ReadingAsync");let t=await this.connectPortAsync(e);if(!t){this._err("failed to connect");return}this._isConnected=!0,this._port=t.port,this._reader=t.reader,this.onSerialConnection&&this.onSerialConnection(this._isConnected),this.startReading()}async stopStage2ClosePortAsync(){this._log("stopStage2ClosePortAsync"),this.closeReader(),await this.closePortAsync()}async connectPortAsync(e){let t=e.getInfo();if(this._log("port info",t),e.readable)return this._err("port is already readable"),null;if(this._log("openning port.."),await e.open({baudrate:230400,baudRate:230400}).catch(n=>{this._err("failed to port.open",n)}),!e.readable)return this._err("port is not readable.."),null;let a=e.readable.getReader();return a.locked?(this._err("reader is locked"),null):{port:e,reader:a}}async startReading(){try{this._log("starting reader..");let e=new F(this._reader);this._log("creating decoder..");let t=await e.readOnce();this.onFirmwareUpdateAvailable&&(this.onFirmwareUpdateAvailable(t.isFirmwareOutdated),this._warn(`New firmware available ? ${t.isFirmwareOutdated}`));let a=t.decoderType,n=t.sensorType,s=U.createReader(a),o=U.createDecoder(a);for(this._log("starting loop.."),this._isReading=!0;this._isReading;){let l=await s.readValue(e),c=await o.decode(l);if(c){if(n!==c.sensorType){this._err(`invalid sensor type. expecting ${n}, but got ${c.sensorType}.`);continue}this.onSerialData&&this.onSerialData(c)}}this._log("loop complete..")}catch(e){this._err("error reading loop startReading",e)}finally{this.stopStage2ClosePortAsync(),this._log("startReading complete")}}},We=new ee,ce=We;var lr=ce;export{ce as SerialService,lr as default};
//# sourceMappingURL=kiwrious-webserial.esm.min.js.map
